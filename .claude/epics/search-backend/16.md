---
name: Caching layer + cache key normalization
status: completed
created: 2026-01-15T21:18:04Z
updated: 2026-01-18T21:34:44Z
github: https://github.com/TWO22-Org/rezipe/issues/16
depends_on: [14]
parallel: false
conflicts_with: []
---

# Task: Caching layer + cache key normalization

## Description
Implement caching service with consistent key normalization for query + locale combinations.

## Acceptance Criteria
- [x] Cache key normalization (lowercase, trim, locale)
- [x] Cache lookup function
- [x] Cache store function with 24h TTL
- [x] Cache hit/miss detection
- [x] Expired entry handling

## Technical Details
- Key format: SHA-256 hash of "v1:query|locale|pageToken" (see cache.ts)
- normalizeQueryKey is async (uses crypto.subtle.digest)
- Returns 64-character hex string for fixed-length, collision-safe keys
- Version prefix ("v1:") ensures future normalization changes don't silently collide
- Store with expires_at = now + 24h (created_at preserved on upsert)
- Return cached: boolean in response
- Corrupted entries are automatically deleted and re-fetched
- Injectable onError callback for testability (avoids ESM stubbing issues)
- Files: src/backend/functions/_shared/cache.ts, src/backend/tests/cache_test.ts

## Implementation Notes
- `normalizeQueryKey(query, locale?, pageToken?)` - Async, returns versioned SHA-256 hash
- `getCachedResults(client, queryKey)` - Lookup with expiration check and Zod validation
- `setCachedResults(client, queryKey, results)` - Upsert with 24h TTL, explicit onConflict
- `deleteCachedResult(client, queryKey, options?)` - Remove invalid/corrupted entries (logs to Sentry or injectable callback)
- `createCacheClient(options?)` - Injectable factory for testability
- `CacheError` - Typed error class with code and retryable properties
- `ErrorCodes` - CACHE_DATABASE_ERROR, CACHE_INVALID_DATA, CACHE_CLIENT_ERROR

## Dependencies
- [x] 001 - search_cache table

## Effort Estimate
- Size: S
- Hours: 3
- Parallel: false
