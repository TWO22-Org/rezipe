# App Shell Epic: Tasks 001-003 Learnings

**Date:** 2026-01-16
**Tasks:** rezipe-v7p (001), rezipe-q4n (002), rezipe-fu0 (003)
**Epic:** app-shell

---

## SwiftUI State Preservation in TabView

**What went wrong:**
NavigationPath placed in child views (HomeView, SearchView) risked state loss when TabView recreates child views on tab switch.

**Root cause:**
TabView can recreate child view hierarchies when switching tabs, especially if child views hold @State. Navigation state should be "owned" by the stable parent view.

**Prevention:**
- Always lift state that must survive view recreation to parent view
- In TabView contexts, move @State for navigation to the TabView itself
- Pass @Binding to children so they can manipulate shared state

**Pattern:**
```swift
// ✅ Correct: State in parent TabView
struct MainTabView: View {
    @State private var homeNavigationPath = NavigationPath()
    @State private var searchNavigationPath = NavigationPath()

    var body: some View {
        TabView {
            HomeView(navigationPath: $homeNavigationPath)  // Binding
            SearchView(navigationPath: $searchNavigationPath)  // Binding
        }
    }
}

// ❌ Incorrect: State in child
struct HomeView: View {
    @State private var navigationPath = NavigationPath()  // Recreated!
}
```

**Commits affected:**
- `23dea44`: Fixed in amend with lifted NavigationPath

---

## SwiftUI-Only API Constraint Enforcement

**What went wrong:**
Used `Color(.systemGray6)` which bridges to UIKit's UIColor system colors, violating "SwiftUI only" PRD constraint.

**Root cause:**
UIKit bridging (Color UIColor initializer) was overlooked despite explicit PRD constraint. Easy to miss because it compiles without error.

**Prevention:**
- Pre-implementation: Extract PRD constraints and list them explicitly
- Use pure SwiftUI color modifiers: `.quaternary`, `.secondary`, `.tertiary`, etc.
- Code review step: Check for UIKit APIs before commit

**Pattern:**
```swift
// ✅ Pure SwiftUI
.background(.quaternary)      // Adaptive system color
.foregroundStyle(.secondary)  // Adaptive text
.fill(.ultraThickMaterial)    // SwiftUI material

// ❌ UIKit bridging
.background(Color(.systemGray6))
.foregroundStyle(UIColor.systemGray2)
```

**Commits affected:**
- `23dea44`: Fixed in amend, replaced with `.quaternary`

---

## Test Pattern for @Binding Views

**What went wrong:**
Initial tests didn't account for views requiring @Binding parameters. Preview patterns were incomplete.

**Root cause:**
After refactoring to use @Binding, test instantiation patterns weren't updated. Preview macros needed adjustment.

**Prevention:**
- After refactoring to @Binding, update tests and previews immediately
- Use `@Previewable @State` macro for preview state in iOS 17+

**Pattern:**
```swift
// ✅ Correct preview with binding
#Preview {
    @Previewable @State var path = NavigationPath()
    HomeView(navigationPath: $path)
}

// ✅ Correct test setup
func testHomeViewInstantiates() {
    // Can't test directly; test through parent with binding
    // or use simpler unit tests for binding inputs
}
```

**Commits affected:**
- `23dea44`: Fixed in amend

---

## Asset Icon and Image File Requirements

**What went wrong:**
AppIcon asset catalog created with Contents.json but no actual image file referenced initially.

**Root cause:**
Xcode project generation assumed placeholder would be added later. Build warnings/errors about missing icon assets weren't caught upfront.

**Prevention:**
- Asset catalogs must include actual image files before first build
- Use Python or CLI tools to generate placeholder images during setup
- Add image generation step to project creation workflow

**Pattern:**
```swift
// Asset structure
Assets.xcassets/
├── AppIcon.appiconset/
│   ├── Contents.json          ✅ Metadata
│   └── AppIcon.png            ✅ Actual 1024x1024 image (REQUIRED)
```

**Commits affected:**
- `a2ba68d`: Fixed with Python PIL to generate placeholder PNG

---

## Swift Version Alignment with Features

**What went wrong:**
Project SWIFT_VERSION set to 5.0 despite repo standard of 5.9+ and need for @Observable macro.

**Root cause:**
Project template defaulted to older Swift version. Constraint not enforced during project creation.

**Prevention:**
- Extract Swift version requirement from repo CLAUDE.md before project generation
- Set SWIFT_VERSION in all 6 build configuration locations (Debug/Release for all targets)
- Use replace_all in edits to ensure consistency

**Pattern:**
```
All 6 locations must match:
- Project Debug SWIFT_VERSION
- Project Release SWIFT_VERSION
- App Target Debug SWIFT_VERSION
- App Target Release SWIFT_VERSION
- Test Target Debug SWIFT_VERSION
- Test Target Release SWIFT_VERSION
```

**Commits affected:**
- `a2ba68d`: Fixed all 6 locations to 5.9

---

## Per-Task Workflow Validation

**What went well:**
The workflow `implement → verify → commit → close beads → sync` was executed consistently across all 3 tasks.

**Key success factors:**
- `bd create` + `bd update --status in_progress` at task start
- Verification loops after implementation steps
- Immediate feedback fixes before amending commits
- `bd update --status closed` + `bd sync` at task completion
- TodoWrite todo list tracking

**Pattern to continue:**
```
1. bd create "<task-name>"
2. bd update <task-id> --status in_progress
3. Implement with verification loops
4. git add + git commit -m "Task: <task-id>"
5. bd update <task-id> --status closed
6. bd sync
7. Clear todo list
```

---

## Metrics & Quality Indicators

| Metric | Value | Notes |
|--------|-------|-------|
| Tasks completed | 3 | Sequential, no parallelization |
| Commits | 3 | One per task, clean history |
| Issues pre-commit | 2 | UIKit bridging, state preservation |
| Tests written | 9 | Unit tests for views + NavigationPath |
| Beads sync | 3/3 (100%) | No sync failures |
| Rework cycles | 2 | Fixed via git amend (best practice) |

---

## Skills to Update

**No new skill files added this cycle.** Existing patterns align with:
- `.claude/skills/swift-expert.md` → @Observable, async/await, property wrappers
- `.claude/rules/standard-patterns.md` → Fail fast, clear errors

**Recommended future skill:** Consider creating `.claude/skills/swiftui-state-management.md` to document TabView state patterns and SwiftUI-only API guidance.

